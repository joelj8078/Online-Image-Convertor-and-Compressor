{% extends "base.html" %}

{% block title %}Upload & Convert{% endblock %}

{% block content %}
<div class="container d-flex justify-content-center align-items-center" style="min-height: 80vh;">
    <div class="upload-container shadow p-4 bg-white rounded">
        <h2 class="text-center">Upload & Convert Images</h2>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=True) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Toggle Dark Mode Button -->
        <button class="btn btn-secondary btn-sm mb-3" onclick="toggleDarkMode()">Toggle Dark Mode</button>

        <!-- Drag & Drop Upload Box -->
        <div class="drag-drop-box" id="dropZone">
            <p>Drag & drop images here or <strong>click to upload</strong></p>
            <input type="file" id="fileInput" name="files" multiple accept="image/*">
        </div>

        <!-- File Preview -->
        <div id="filePreview" class="mt-3"></div>

        <!-- Upload Form -->
        <form id="uploadForm" method="POST" action="{{ url_for('upload') }}" enctype="multipart/form-data">
            <input type="file" id="hiddenFileInput" name="files" multiple hidden> <!-- Hidden Input now receives files -->
            
            <select class="form-select mt-3" name="format" required>
                <option value="png">PNG</option>
                <option value="jpeg">JPEG</option>
                <option value="webp">WEBP</option>
                <option value="bmp">BMP</option>
                <option value="gif">GIF</option>
            </select>
            <button type="submit" class="btn btn-primary w-100 mt-3">Convert Images</button>
        </form>
    </div>
</div>

<style>
    body {
        background-color: #f8f9fa;
    }
    .upload-container {
        width: 100%;
        max-width: 600px;
    }
    .drag-drop-box {
        border: 2px dashed #007bff;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        transition: 0.3s;
    }
    .drag-drop-box:hover {
        background-color: #e9ecef;
    }
    .dark-mode {
        background-color: #343a40;
        color: white;
    }
    .dark-mode .upload-container {
        background-color: #454d55;
        color: white;
    }
</style>

<script>
    function toggleDarkMode() {
        document.body.classList.toggle("dark-mode");
        localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
    }
    if (localStorage.getItem("darkMode") === "true") document.body.classList.add("dark-mode");

    document.getElementById("dropZone").addEventListener("click", () => document.getElementById("fileInput").click());

    // Drag & Drop functionality
    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("fileInput");
    const hiddenFileInput = document.getElementById("hiddenFileInput");
    const filePreview = document.getElementById("filePreview");

    dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.style.backgroundColor = "#e9ecef";
    });

    dropZone.addEventListener("dragleave", () => {
        dropZone.style.backgroundColor = "white";
    });

    dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.style.backgroundColor = "white";
        fileInput.files = e.dataTransfer.files;
        hiddenFileInput.files = e.dataTransfer.files; // Ensure form receives files
        previewFiles(fileInput.files);
    });

    fileInput.addEventListener("change", () => {
        hiddenFileInput.files = fileInput.files; // Bind selected files to form
        previewFiles(fileInput.files);
    });

    function previewFiles(files) {
        filePreview.innerHTML = "";
        for (let file of files) {
            let fileReader = new FileReader();
            fileReader.readAsDataURL(file);
            fileReader.onload = (e) => {
                let img = document.createElement("img");
                img.src = e.target.result;
                img.style.width = "80px";
                img.style.marginRight = "10px";
                img.style.borderRadius = "5px";
                filePreview.appendChild(img);
            };
        }
    }
</script>
{% endblock %}
